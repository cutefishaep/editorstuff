<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent: #007AFF;
            --accent-gradient: linear-gradient(180deg, #3294ff 0%, #007AFF 100%);
            --sidebar-bg: rgba(30, 30, 35, 0.5);
            --main-bg: rgba(25, 25, 30, 0.7);
            --item-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text: #FFFFFF;
            --text-dim: rgba(255, 255, 255, 0.4);
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background: url('https://images.unsplash.com/photo-1629131726692-1accd0c53ce0?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            overflow: hidden;
        }

        /* Lock Screen Style */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(60px) brightness(0.5);
            -webkit-backdrop-filter: blur(60px) brightness(0.5);
            background: rgba(0, 0, 0, 0.4);
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            color: white;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .login-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .login-input-container h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .pass-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 25px;
            color: white;
            text-align: center;
            width: 220px;
            outline: none;
            transition: all 0.3s;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .pass-field:focus {
            background: rgba(255, 255, 255, 0.2);
            width: 260px;
            border-color: var(--accent);
        }

        .hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Window Style */
        .window {
            width: 1100px;
            height: 750px;
            background: var(--main-bg);
            backdrop-filter: blur(60px) saturate(210%);
            -webkit-backdrop-filter: blur(60px) saturate(210%);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
            display: flex;
            overflow: hidden;
            transition: filter 0.5s ease;
        }

        .window.locked-blur {
            display: none !important;
            visibility: hidden;
            pointer-events: none;
            user-select: none;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
            padding: 10px 12px 28px;
        }

        .light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .red {
            background: #FF5F56;
            cursor: pointer;
        }

        .yellow {
            background: #FFBD2E;
        }

        .green {
            background: #27C93F;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            padding: 0 12px 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 400;
            margin-bottom: 3px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .nav-item[onclick="logout()"]:hover {
            background: rgba(255, 69, 58, 0.15) !important;
        }

        .nav-item.active {
            background: var(--accent);
            font-weight: 600;
        }

        .nav-item i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .bg-win {
            background: linear-gradient(180deg, #00adef, #0078d4);
        }

        .bg-mac {
            background: linear-gradient(180deg, #666, #333);
        }

        .bg-presets {
            background: linear-gradient(180deg, #ffb347, #ff9500);
        }

        /* Main Area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            padding: 30px 40px 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .toolbar-left h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        /* Controls */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0 40px 40px;
        }

        /* Table */
        .table-wrap {
            background: var(--item-bg);
            border-radius: 12px;
            border: 0.5px solid var(--border);
            margin-top: 20px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 18px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        td {
            padding: 14px 18px;
            font-size: 13px;
            border-bottom: 0.5px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .action-btns {
            display: flex;
            gap: 12px;
        }

        .edit-btn {
            color: var(--accent);
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            font-size: 14px;
            transition: 0.2s;
        }

        .del-btn {
            color: #FF453A;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            font-size: 14px;
            transition: 0.2s;
        }

        .edit-btn:hover,
        .del-btn:hover {
            transform: scale(1.2);
        }

        /* Modal / Popup */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            width: 500px;
            background: rgba(40, 40, 45, 0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            padding: 0;
            overflow: hidden;
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 18px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body {
            padding: 25px;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-row label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .form-row input,
        .form-row select {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: white;
            font-size: 13px;
            box-sizing: border-box;
            outline: none;
        }

        .form-row input:focus {
            border-color: var(--accent);
        }

        .modal-footer {
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.1s;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-danger {
            background: rgba(255, 69, 58, 0.15);
            color: #FF453A;
        }

        .btn:hover {
            filter: brightness(1.2);
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* Sidebar info container fix */
        .sidebar-footer {
            margin-top: auto;
            padding: 15px;
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        #json-preview {
            width: 100%;
            height: 180px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            font-family: "SF Mono", monospace;
            font-size: 12px;
            color: #79C0FF;
            resize: none;
            outline: none;
            margin-top: 10px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            z-index: 10000;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .shake {
            animation: shake 0.2s ease-in-out 0s 2;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        /* Toggle Switch */
        .input-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
            gap: 4px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: none;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
        }

        /* Dropzone */
        .dropzone {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
            position: relative;
        }

        .dropzone:hover,
        .dropzone.dragover {
            border-color: var(--accent);
            background: rgba(0, 122, 255, 0.05);
        }

        .dropzone i {
            font-size: 30px;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .dropzone p {
            margin: 0;
            font-size: 12px;
            color: var(--text-dim);
        }

        .file-info {
            margin-top: 10px;
            font-size: 12px;
            color: #34c759;
            font-weight: 600;
            display: none;
        }

        .hidden-el {
            display: none !important;
        }

        /* Instruction Templates */
        .template-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .template-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            font-weight: 700;
        }

        .t-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .t-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }
    </style>
</head>

<body>

    <!-- Lock Screen -->
    <div id="lock-screen" class="lock-screen">
        <div class="user-avatar"><i class="fa-solid fa-lock"></i></div>
        <div class="login-input-container">
            <h2>Administrator</h2>
            <div style="position: relative; display: flex; align-items: center;">
                <input type="password" id="admin-pass" class="pass-field" placeholder="Enter Password"
                    onkeydown="handleLogin(event)">
                <button onclick="handleLogin({key: 'Enter'})"
                    style="position: absolute; right: 10px; background: none; border: none; color: white; cursor: pointer; opacity: 0.6; transition: 0.2s;"
                    onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </button>
            </div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 10px;">Security enabled</div>
        </div>
    </div>

    <!-- Main Window -->
    <div class="window locked-blur" id="main-window">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="traffic-lights">
                <div class="light red" onclick="location.href='index.html'"></div>
                <div class="light yellow"></div>
                <div class="light green"></div>
            </div>

            <div class="sidebar-title">Library</div>
            <div class="nav-item active" data-type="win">
                <i class="fa-brands fa-windows bg-win"></i>
                <span>Windows Library</span>
            </div>
            <div class="nav-item" data-type="mac">
                <i class="fa-brands fa-apple bg-mac"></i>
                <span>macOS Library</span>
            </div>
            <div class="nav-item" data-type="presets">
                <i class="fa-solid fa-sliders bg-presets"></i>
                <span>Global Presets</span>
            </div>

            <div style="flex: 1;"></div>

            <div class="nav-item" onclick="logout()" style="margin-bottom: 20px; color: #FF453A;">
                <i class="fa-solid fa-right-from-bracket"
                    style="background: rgba(255, 69, 58, 0.1); color: #FF453A;"></i>
                <span>Log Out</span>
            </div>

            <div class="sidebar-footer">
                <i class="fa-solid fa-circle-info" style="margin-right: 5px;"></i>
                Use <b>Sync to Disk</b> to save changes permanently to your JSON files.
            </div>
        </div>

        <!-- Main Area -->
        <div class="main">
            <div class="toolbar">
                <div class="toolbar-left">
                    <h1 id="view-title">Windows Library</h1>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openModal()" id="add-item-btn">
                        <i class="fa-solid fa-plus"></i> Add New
                    </button>
                    <button class="btn btn-secondary" onclick="syncToDisk()" id="sync-btn"
                        style="background: rgba(52, 199, 89, 0.1); color: #34c759; border: 1px solid rgba(52, 199, 89, 0.2);">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Sync to Disk
                    </button>
                    <button class="btn btn-secondary" onclick="copyJSON()">
                        <i class="fa-solid fa-copy"></i> Copy
                    </button>
                </div>
            </div>

            <div class="content-scroll">
                <div id="connection-status"
                    style="margin-bottom: 20px; padding: 10px 15px; border-radius: 8px; font-size: 11px; display: none;">
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--text-dim);">ACTIVE LIST
                        </h3>
                        <select id="category-filter" onchange="applyFilter()"
                            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: white; font-size: 11px; padding: 2px 8px; outline: none; cursor: pointer; display: none;">
                            <option value="ALL">All Categories</option>
                            <option value="SOFTWARE">Software / Apps</option>
                            <option value="PLUGIN">Plugins / Add-ons</option>
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="clearAll()"
                        style="font-size: 11px; padding: 4px 10px; opacity: 0.6;">
                        <i class="fa-solid fa-trash-can"></i> Clear All
                    </button>
                </div>

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>OS / Info</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="list-body"></tbody>
                    </table>
                </div>

                <div style="margin-top: 40px;">
                    <div
                        style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 10px;">
                        JSON Output Preview</div>
                    <textarea id="json-preview" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Item</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:white; cursor:pointer;"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Filename</label>
                    <input type="text" id="f-name" placeholder="e.g. Photoshop 2025">
                </div>
                <div class="form-row">
                    <label>Category</label>
                    <select id="f-category">
                        <option value="SOFTWARE">Software (App)</option>
                        <option value="PLUGIN">Plugin / Add-on</option>
                        <option value="PRESET">Preset / Asset</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="f-os">System / OS Version</label>
                    <input type="text" id="f-os" placeholder="e.g. Windows 11 / Sequoia">
                </div>
                <div class="form-row">
                    <label for="f-size">File Size</label>
                    <input type="text" id="f-size" placeholder="e.g. 1.2 GB">
                </div>
                <div class="form-row" id="download-mode-row" style="display: none;">
                    <label>Download Mode</label>
                    <div class="input-toggle">
                        <button class="toggle-btn active" id="mode-link" onclick="setDownloadMode('link')">External
                            Link</button>
                        <button class="toggle-btn" id="mode-upload" onclick="setDownloadMode('upload')">Local
                            Upload</button>
                    </div>
                </div>

                <div class="form-row" id="link-input-group">
                    <label id="link-label">Download Link</label>
                    <input type="text" id="f-link" placeholder="https://...">
                </div>

                <div class="form-row hidden-el" id="upload-input-group">
                    <label>Upload File</label>
                    <div class="dropzone" id="dropzone">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <p>Drag & Drop file here or <b>Click to Browse</b></p>
                        <input type="file" id="f-upload" style="display:none;">
                        <div class="file-info" id="file-info"></div>
                    </div>
                </div>

                <div class="form-row" id="preview-row" style="display:none;">
                    <label>Upload Preview (Photo/Video)</label>
                    <div class="dropzone" id="preview-dropzone" style="padding: 15px;">
                        <i class="fa-solid fa-image" style="font-size: 20px;"></i>
                        <p style="font-size: 10px;">Drag & Drop preview or <b>Click to Browse</b></p>
                        <input type="file" id="f-preview" style="display:none;" accept="image/*,video/*">
                        <div class="file-info" id="preview-info" style="font-size: 10px;"></div>
                    </div>
                </div>
                <div class="form-row" id="instruction-row">
                    <label style="display:block; margin-bottom: 5px;">Installation Instruction</label>
                    <div id="win-templates" class="template-row" style="display:none;">
                        <span class="template-label">Templates:</span>
                        <button class="t-btn" onclick="applyTemplate('win', 'CEP')">CEP (Extension)</button>
                        <button class="t-btn" onclick="applyTemplate('win', 'AEX')">AEX (Plugin)</button>
                        <button class="t-btn" onclick="applyTemplate('win', 'FFX')">FFX (Preset)</button>
                    </div>
                    <div id="mac-templates" class="template-row" style="display:none;">
                        <span class="template-label">Templates:</span>
                        <button class="t-btn" onclick="applyTemplate('mac', 'CEP')">CEP (Extension)</button>
                        <button class="t-btn" onclick="applyTemplate('mac', 'PLUGIN')">PLUGIN (AEX)</button>
                        <button class="t-btn" onclick="applyTemplate('mac', 'FFX')">FFX (Preset)</button>
                    </div>
                    <textarea id="f-instruction" placeholder="Enter step-by-step instructions here..."
                        style="width: 100%; height: 80px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; padding: 10px; font-family: inherit; font-size: 12px; resize: vertical; box-sizing: border-box; outline: none; transition: border-color 0.2s;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="save-btn" onclick="saveItem()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">âœ… Action Successful!</div>

    <script>
        const MASTER_PASS_HASH = 'd0d1b8cd954adcb5e80db4d96129f9ef1c1a5bdb5c95c74531129a02cbf87345';

        async function sha256(str) {
            const buf = new TextEncoder().encode(str);
            const hash = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function handleLogin(e) {
            if (e.key === 'Enter') {
                const pass = document.getElementById('admin-pass').value;
                const hashed = await sha256(pass);
                if (hashed === MASTER_PASS_HASH) {
                    document.getElementById('lock-screen').classList.add('hidden');
                    document.getElementById('main-window').classList.remove('locked-blur');
                    sessionStorage.setItem('authenticated', 'true');
                } else {
                    const el = document.getElementById('admin-pass');
                    el.classList.add('shake'); el.style.borderColor = '#FF453A';
                    setTimeout(() => { el.classList.remove('shake'); el.style.borderColor = ''; }, 400);
                }
            }
        }

        if (sessionStorage.getItem('authenticated') === 'true') {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-window').classList.remove('locked-blur');
            });
        }

        function logout() {
            if (confirm("Are you sure you want to log out?")) {
                sessionStorage.removeItem('authenticated');
                location.reload();
            }
        }

        // State
        let currentType = 'win';
        let dataMap = { win: [], mac: [], presets: [] };
        let editingIndex = -1;
        let currentFilter = 'ALL';
        let downloadMode = 'link'; // 'link' or 'upload'
        let selectedFile = null;
        let selectedPreviewFile = null;

        const navItems = document.querySelectorAll('.nav-item');
        const viewTitle = document.getElementById('view-title');
        const listBody = document.getElementById('list-body');
        const jsonPreview = document.getElementById('json-preview');
        const overlay = document.getElementById('modal-overlay');
        const filterSelect = document.getElementById('category-filter');

        // File Selection Logic
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('f-upload');
        const fileInfo = document.getElementById('file-info');

        if (dropzone) {
            dropzone.onclick = () => fileInput.click();

            dropzone.ondragover = (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            };

            dropzone.ondragleave = () => {
                dropzone.classList.remove('dragover');
            };

            dropzone.ondrop = (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            };
        }

        if (fileInput) {
            fileInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            };
        }

        function handleFileSelection(file) {
            selectedFile = file;
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2) + " MB";
            fileInfo.innerText = `Selected: ${file.name} (${sizeInMB})`;
            fileInfo.style.display = 'block';

            // Auto-populate size field
            document.getElementById('f-size').value = sizeInMB;

            if (currentType === 'presets') detectFormat(file.name);
        }

        // Preview Selection Logic
        const previewDropzone = document.getElementById('preview-dropzone');
        const previewInput = document.getElementById('f-preview');
        const previewInfo = document.getElementById('preview-info');

        if (previewDropzone) {
            previewDropzone.onclick = () => previewInput.click();
            previewDropzone.ondragover = (e) => { e.preventDefault(); previewDropzone.classList.add('dragover'); };
            previewDropzone.ondragleave = () => previewDropzone.classList.remove('dragover');
            previewDropzone.ondrop = (e) => {
                e.preventDefault();
                previewDropzone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handlePreviewSelection(e.dataTransfer.files[0]);
            };
        }

        if (previewInput) {
            previewInput.onchange = (e) => {
                if (e.target.files.length > 0) handlePreviewSelection(e.target.files[0]);
            };
        }

        function handlePreviewSelection(file) {
            selectedPreviewFile = file;
            previewInfo.innerText = `Preview: ${file.name}`;
            previewInfo.style.display = 'block';
        }

        function detectFormat(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const categorySelect = document.getElementById('f-category');
            if (ext === 'ffx') {
                categorySelect.value = 'PRESET';
            } else if (ext === 'aep') {
                categorySelect.value = 'PROJECT';
            } else if (ext === 'zip' || ext === '7z' || ext === 'rar') {
                categorySelect.value = 'PACK';
            }
        }

        function setDownloadMode(mode) {
            downloadMode = mode;
            document.getElementById('mode-link').classList.toggle('active', mode === 'link');
            document.getElementById('mode-upload').classList.toggle('active', mode === 'upload');

            document.getElementById('link-input-group').classList.toggle('hidden-el', mode === 'upload');
            document.getElementById('upload-input-group').classList.toggle('hidden-el', mode === 'link');

            // Toggle size visibility for presets: link needs manual size, upload gets it auto
            if (currentType === 'presets') {
                const sizeRow = document.querySelector('label[for="f-size"]').closest('.form-row');
                sizeRow.style.display = (mode === 'link' ? 'block' : 'none');
            }
        }

        function resetFormState() {
            setDownloadMode('link');
            selectedFile = null;
            selectedPreviewFile = null;
            if (fileInfo) fileInfo.style.display = 'none';
            if (fileInput) fileInput.value = '';
            if (previewInfo) previewInfo.style.display = 'none';
            if (previewInput) previewInput.value = '';
        }

        // Section-specific configurations
        const sectionConfig = {
            win: {
                osLabel: 'Windows Version',
                osPlaceholder: 'e.g. Windows 10, Windows 11, Windows Server',
                sizeLabel: 'File Size',
                sizePlaceholder: 'e.g. 1.2 GB',
                categories: [
                    { value: 'SOFTWARE', label: 'Software (Full App)' },
                    { value: 'PLUGIN', label: 'Plugin / Extension' },
                    { value: 'PRESET', label: 'Preset / Template' }
                ],
                showInstruction: true
            },
            mac: {
                osLabel: 'macOS Version',
                osPlaceholder: 'e.g. Sequoia, Sonoma, Ventura',
                sizeLabel: 'File Size',
                sizePlaceholder: 'e.g. 1.2 GB',
                categories: [
                    { value: 'SOFTWARE', label: 'Software (Full App)' },
                    { value: 'PLUGIN', label: 'Plugin / Extension' },
                    { value: 'PRESET', label: 'Preset / Template' }
                ],
                showInstruction: true
            },
            presets: {
                osLabel: 'Minimum (AE Version)',
                osPlaceholder: 'e.g. CC 2020 / v24.0',
                sizeLabel: 'Size',
                sizePlaceholder: 'e.g. 10 MB',
                categories: [
                    { value: 'PRESET', label: 'Preset' },
                    { value: 'PROJECT', label: 'Project Files' },
                    { value: 'PACK', label: 'Archive pack' }
                ],
                showInstruction: false,
                hideFormat: true
            }
        };

        // Logic
        async function init() {
            try {
                const [win, mac, presets] = await Promise.all([
                    fetch('list_win.json').then(r => r.json()),
                    fetch('list_mac.json').then(r => r.json()),
                    fetch('list_presets.json').then(r => r.json())
                ]);
                dataMap.win = win; dataMap.mac = mac; dataMap.presets = presets;

                // Initialize filter visibility
                if (filterSelect) {
                    filterSelect.style.display = (currentType === 'presets') ? 'none' : 'block';
                }

                render();
            } catch (e) {
                const saved = localStorage.getItem('editorstuff_data');
                if (saved) dataMap = JSON.parse(saved);
                render();
            }
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                currentType = item.dataset.type;
                viewTitle.innerText = item.querySelector('span').innerText;

                // Filter dropdown logic
                currentFilter = 'ALL';
                if (filterSelect) {
                    filterSelect.value = 'ALL';
                    filterSelect.style.display = (currentType === 'presets') ? 'none' : 'block';
                }

                render();
            });
        });

        function applyFilter() {
            currentFilter = filterSelect.value;
            render();
        }

        function render() {
            const originalList = dataMap[currentType];
            const isPreset = currentType === 'presets';

            // Map original list to include indices for filtering
            let listToRender = originalList.map((item, index) => ({ item, index }));

            // Apply Category Filter if not Global Presets
            if (!isPreset && currentFilter !== 'ALL') {
                listToRender = listToRender.filter(entry => entry.item.category === currentFilter);
            }

            // Update table headers based on section
            const thead = document.querySelector('table thead tr');
            if (isPreset) {
                thead.innerHTML = '<th>Name</th><th>Category</th><th>Min (AE)</th><th style="width: 100px;">Actions</th>';
            } else {
                thead.innerHTML = '<th>Name</th><th>Category</th><th>OS / Info</th><th>Size</th><th style="width: 100px;">Actions</th>';
            }

            listBody.innerHTML = '';
            listToRender.forEach(({ item, index }) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${item.filename}</td>
                    <td><span style="opacity:0.6; font-size:11px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;">${item.category}</span></td>
                    <td>${item.os_min}</td>
                    ${isPreset ? '' : `<td>${item.size || '-'}</td>`}
                    <td>
                        <div class="action-btns">
                            <button title="Edit" class="edit-btn" onclick="openModal(${index})"><i class="fa-solid fa-pencil"></i></button>
                            <button title="Delete" class="del-btn" onclick="deleteItem(${index})"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </td>
                `;
                listBody.appendChild(tr);
            });
            // Update JSON preview with correctly filtered data (items only)
            jsonPreview.value = JSON.stringify(listToRender.map(e => e.item), null, 4);
        }

        function openModal(index = -1) {
            resetInputs();
            editingIndex = index;
            resetFormState();

            const config = sectionConfig[currentType];

            // Update Labels & Dynamic UI
            const osLabel = document.querySelector('label[for="f-os"]');
            const osInput = document.getElementById('f-os');
            osLabel.textContent = config.osLabel;
            osInput.placeholder = config.osPlaceholder;

            const sizeLabel = document.querySelector('label[for="f-size"]');
            const sizeInput = document.getElementById('f-size');
            sizeLabel.textContent = config.sizeLabel;
            const sizeRow = document.querySelector('label[for="f-size"]').closest('.form-row');

            // Initial size visibility based on config
            sizeRow.style.display = config.hideFormat ? 'none' : 'block';

            // Rebuild category dropdown
            const categorySelect = document.getElementById('f-category');
            categorySelect.innerHTML = '';
            config.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.label;
                categorySelect.appendChild(option);
            });

            // Show Link/Upload toggle ONLY for Global Presets
            document.getElementById('download-mode-row').style.display = (currentType === 'presets' ? 'block' : 'none');

            if (index > -1) {
                const item = dataMap[currentType][index];
                document.getElementById('modal-title').innerText = "Edit Item";
                document.getElementById('f-name').value = item.filename;
                document.getElementById('f-category').value = item.category;
                document.getElementById('f-os').value = item.os_min;
                document.getElementById('f-size').value = item.size;

                // NEW: Collect all linkN values and join them with a space
                const linkSet = new Set();
                Object.keys(item).forEach(key => {
                    if (/^link\d*$/.test(key) && item[key]) {
                        linkSet.add(item[key]);
                    }
                });
                document.getElementById('f-link').value = Array.from(linkSet).join(' ');

                document.getElementById('f-instruction').value = item.instruction || "";

                // Improved Mode Detection for all types
                const firstLink = Array.from(linkSet)[0] || "";
                if (firstLink.startsWith('/file/')) {
                    setDownloadMode('upload');
                    fileInfo.innerText = "Current File: " + firstLink.split('/').pop();
                    fileInfo.style.display = 'block';
                } else {
                    setDownloadMode('link');
                }

                if (currentType === 'presets' && item.preview) {
                    previewInfo.innerText = "Current Preview: " + item.preview.split('/').pop();
                    previewInfo.style.display = 'block';
                }
            } else {
                document.getElementById('modal-title').innerText = "Add New Item";
            }

            document.getElementById('preview-row').style.display = (currentType === 'presets' ? 'block' : 'none');

            const instRow = document.getElementById('instruction-row');
            if (config.showInstruction) {
                instRow.style.display = 'block';
                // Show relevant templates
                document.getElementById('win-templates').style.display = (currentType === 'win' || currentType === 'presets' ? 'flex' : 'none');
                document.getElementById('mac-templates').style.display = (currentType === 'mac' || currentType === 'presets' ? 'flex' : 'none');
            } else {
                instRow.style.display = 'none';
            }

            overlay.classList.add('active');
        }

        const instructionTemplates = {
            win: {
                CEP: "1. Run the .reg file to enable Debug Mode.\n2. Copy the extension to: C:\\Program Files (x86)\\Common Files\\Adobe\\CEP\\extensions\\\n3. Restart After Effects.\n4. Window > Extensions.",
                AEX: "1. Copy the .aex file to: C:\\Program Files\\Adobe\\Common\\Plug-ins\\7.0\\MediaCore\\\n2. Restart After Effects.",
                FFX: "1. Copy the .ffx file to: Documents\\Adobe\\After Effects <version>\\User Presets\\\n2. Find it in the Effects & Presets panel."
            },
            mac: {
                CEP: "1. Open Terminal and run: \ndefaults write com.adobe.CSXS.13 PlayerDebugMode 1\ndefaults write com.adobe.CSXS.12 PlayerDebugMode 1\ndefaults write com.adobe.CSXS.11 PlayerDebugMode 1\n2. Copy extension to: /Library/Application Support/Adobe/CEP/extensions/\n3. Restart After Effects.\n4. Window > Extensions.",
                PLUGIN: "1. Copy the plugin to: /Library/Application Support/Adobe/Common/Plug-ins/7.0/MediaCore/\n2. Restart After Effects.",
                FFX: "1. Copy the .ffx file to: Documents/Adobe/After Effects <version>/User Presets/\n2. Find it in the Effects & Presets panel."
            }
        };

        function applyTemplate(os, type) {
            const text = instructionTemplates[os][type];
            const area = document.getElementById('f-instruction');
            if (area.value.trim() !== "") {
                if (confirm("Replace current instruction with template?")) {
                    area.value = text;
                }
            } else {
                area.value = text;
            }
        }

        function closeModal() {
            overlay.classList.remove('active');
            resetInputs();
            resetFormState();
        }

        function resetInputs() {
            document.getElementById('f-name').value = '';
            document.getElementById('f-os').value = '';
            document.getElementById('f-size').value = '';
            document.getElementById('f-link').value = '';
            document.getElementById('f-instruction').value = '';
            editingIndex = -1;
        }

        async function saveItem() {
            const name = document.getElementById('f-name').value;
            const cat = document.getElementById('f-category').value;
            const os = document.getElementById('f-os').value;
            const size = document.getElementById('f-size').value;
            let link = document.getElementById('f-link').value;
            const instruction = document.getElementById('f-instruction').value;
            let originalName = editingIndex > -1 ? (dataMap[currentType][editingIndex].originalName || "") : "";

            // Validation: Size is optional for Presets if uploading (auto-populated)
            const isSizeRequired = currentType !== 'presets' || downloadMode === 'link';
            if (!name || !os || (isSizeRequired && !size)) return alert("Fill required fields");

            if (downloadMode === 'upload' && selectedFile) {
                originalName = selectedFile.name; // Store original name
                const formData = new FormData();
                formData.append('file', selectedFile);

                try {
                    showToast("Uploading file...");
                    const res = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const resData = await res.json();
                    if (resData.success) {
                        link = resData.filePath;
                    } else {
                        return alert("Upload failed: " + resData.message);
                    }
                } catch (e) {
                    return alert("Upload error. Check console.");
                }
            }

            let previewUrl = editingIndex > -1 ? dataMap[currentType][editingIndex].preview : "";
            if (currentType === 'presets' && selectedPreviewFile) {
                const formData = new FormData();
                formData.append('file', selectedPreviewFile);
                try {
                    showToast("Uploading preview...");
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    const resData = await res.json();
                    if (resData.success) previewUrl = resData.filePath;
                } catch (e) {
                    console.error("Preview upload failed", e);
                }
            }

            // NEW: Parse multiple links separated by spaces
            const linkArr = link.split(/\s+/).filter(l => l.trim() !== "");

            const item = {
                id: editingIndex > -1 ? dataMap[currentType][editingIndex].id : Date.now(),
                filename: name,
                category: cat,
                os_min: os,
                size: size,
                instruction: instruction,
                originalName: originalName
            };
            if (currentType === 'presets') item.preview = previewUrl;

            // STRICT: Dynamically add link1, link2, etc. ONLY
            linkArr.forEach((url, i) => {
                item[`link${i + 1}`] = url;
            });

            if (editingIndex > -1) {
                dataMap[currentType][editingIndex] = item;
            } else {
                dataMap[currentType].push(item);
            }

            closeModal();
            render();
            localStorage.setItem('editorstuff_data', JSON.stringify(dataMap));
            showToast("Item saved locally");
        }

        async function deleteItem(index) {
            const item = dataMap[currentType][index];
            if (confirm(`Permanently delete "${item.filename}"? This will also remove any uploaded files on the server.`)) {
                // Find all uploaded files (main files and previews)
                const filesToDelete = [];
                Object.keys(item).forEach(key => {
                    const val = item[key];
                    if (typeof val === 'string' && val.startsWith('/file/')) {
                        filesToDelete.push(val);
                    }
                });

                // Delete each file from server
                for (const filePath of filesToDelete) {
                    try {
                        await fetch('/delete-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath })
                        });
                    } catch (e) {
                        console.error("Cleanup failed:", e);
                    }
                }

                dataMap[currentType].splice(index, 1);
                render();
                localStorage.setItem('editorstuff_data', JSON.stringify(dataMap));
                showToast("Item and files deleted");
            }
        }

        function clearAll() {
            if (confirm("WARNING: Clear entire category list?")) {
                dataMap[currentType] = [];
                render();
                localStorage.setItem('editorstuff_data', JSON.stringify(dataMap));
            }
        }

        async function syncToDisk() {
            const syncBtn = document.getElementById('sync-btn');
            const original = syncBtn.innerHTML;
            syncBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...';

            const filename = `list_${currentType}.json`;
            const data = dataMap[currentType];
            try {
                const res = await fetch('/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, data })
                });
                const resData = await res.json();
                if (resData.success) {
                    showToast("âœ… Successfully synced to disk!");
                }
            } catch (e) {
                alert("Sync Failed. Please ensure 'node server.js' is running in the terminal.");
            } finally {
                syncBtn.innerHTML = original;
            }
        }

        function copyJSON() {
            jsonPreview.select();
            document.execCommand('copy');
            showToast("JSON Copied to clipboard!");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        init();
        if (window.location.port == '3000') {
            const s = document.getElementById('connection-status');
            s.style.display = 'block'; s.style.color = '#34c759'; s.style.background = 'rgba(52,199,89,0.1)';
            s.innerHTML = '<i class="fa-solid fa-circle-check"></i> Connected to Node.js Server';
        } else {
            const s = document.getElementById('connection-status');
            s.style.display = 'block'; s.style.color = '#FF9500'; s.style.background = 'rgba(255,149,0,0.1)';
            s.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Using file mode. Run "node server.js" to enable Sync.';
        }
    </script>
</body>

</html>